<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR –ü—Ä–∏–º–µ—Ä–∫–∞ –ö–æ–ª—å—Ü–∞</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    canvas, video { position: absolute; top: 0; left: 0; }
    #ui {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.8); padding: 10px; border-radius: 8px;
    }
    button {
      margin: 2px; padding: 5px 10px; cursor: pointer;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline style="display:none;"></video>
  <div id="ui">
    <strong>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ª–µ—Ü:</strong><br>
    <button data-id="4">üëç –ë–æ–ª—å—à–æ–π</button>
    <button data-id="8">‚òù –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π</button>
    <button data-id="12">üññ –°—Ä–µ–¥–Ω–∏–π</button>
    <button data-id="16">üñê –ë–µ–∑—ã–º—è–Ω–Ω—ã–π</button>
    <button data-id="20">ü§è –ú–∏–∑–∏–Ω–µ—Ü</button>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
    import { Hands } from 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js';
    import { Camera } from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';

    const video = document.getElementById('video');
    let selectedLandmark = 16; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –±–µ–∑—ã–º—è–Ω–Ω—ã–π

    // UI –≤—ã–±–æ—Ä –ø–∞–ª—å—Ü–∞
    document.querySelectorAll("button").forEach(btn => {
      btn.onclick = () => {
        selectedLandmark = parseInt(btn.dataset.id);
      };
    });

    // Three.js —Å—Ü–µ–Ω–∞
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 100);
    const renderer = new THREE.WebGLRenderer({ alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    camera.position.z = 1.5;

    const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
    scene.add(light);

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª—å—Ü–∞
    const loader = new GLTFLoader();
    let ring;
    loader.load('ring.glb', (gltf) => {
      ring = gltf.scene;
      ring.scale.set(0.05, 0.05, 0.05);
      scene.add(ring);
    });

    // MediaPipe Hands
    const hands = new Hands({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    hands.onResults(onResults);

    const mpCamera = new Camera(video, {
      onFrame: async () => {
        await hands.send({ image: video });
      },
      width: 640,
      height: 480
    });
    mpCamera.start();

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function onResults(results) {
      if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0 || !ring) return;

      const landmarks = results.multiHandLandmarks[0];

      const lm = landmarks[selectedLandmark];
      const base = landmarks[selectedLandmark - 2] || lm;

      const x = (lm.x - 0.5) * 2;
      const y = -(lm.y - 0.5) * 2;
      const z = -lm.z;

      ring.position.set(x, y, z);

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Å—à—Ç–∞–± –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –ø–∞–ª—å—Ü–∞
      const dx = lm.x - base.x;
      const dy = lm.y - base.y;
      const dz = lm.z - base.z;
      const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
      const scale = dist * 4; // —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è
      ring.scale.set(scale, scale, scale);

      ring.lookAt(camera.position); // –ü–æ–≤–µ—Ä–Ω—É—Ç—å –∫ –∫–∞–º–µ—Ä–µ
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
